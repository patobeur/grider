<!DOCTYPE html>
<html lang="fr">

	<head>
		<title>three.js physics</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<style>
			body {
				overflow: hidden;
				margin: 0px;
			}

			#menuPanel {
				position: absolute;
				background-color: rgba(255, 255, 255, 0.25);
				top: 0px;
				left: 0px;
				width: 100%;
				height: 100%;
			}

			#startButton {
				height: 50px;
				width: 200px;
				/* margin: -25px -100px; */
				position: relative;
				/* top: 50%;
				left: 50%; */
				font-size: 32px;
				background-color: rgba(255, 255, 255, 1);
				text-align: center;
			}
		</style>
	</head>

	<body>
		<script src="/tanks/node_modules/three/examples/jsm/libs/ammo.wasm.js"></script>
		<script type="importmap">
		{
          "imports": {
            "three": "/tanks/node_modules/three/build/three.module.js",
            "three/addons/": "/tanks/node_modules/three/examples/jsm/"
          }
        }
      	</script>
		<script type="module">
			"use strict";
			import * as THREE from "three";
			import { _GLTFLoader, _TextureLoader, _scene, _consoleOn, _formulas } from '/tanks/loaders.js'
			import { _physics } from '/tanks/physics.js';
			import { _OrbitControls } from '/tanks/OrbitControls.js';
			// 
			import { clone } from 'three/addons/utils/SkeletonUtils.js';
			let userWindowsConsole = function () {
				// Exemple de fonction pour manipuler le tank via la console
				window.setColor = function (r = 0, g = 0, b = 0) {
					let Skin = _Player.playerModel.children[0].children[0]
					Skin.material.color.r = r
					Skin.material.color.g = g
					Skin.material.color.b = b
				};
				window.setColor2 = function (r = 0, g = 0, b = 0) {
					let Skin = _Player.playerModel.children[0].children[3]
					Skin.material.color.r = r
					Skin.material.color.g = g
					Skin.material.color.b = b
				};
				window.moveTankForward = function () {
					_Player.moveForward = true;
					_Player.moveBackward = false;
				};

				window.moveTankBackward = function () {
					_Player.moveForward = false;
					_Player.moveBackward = true;
				};

				window.stopTank = function () {
					_Player.moveForward = false;
					_Player.moveBackward = false;
				};
			}
			let _Player = {
				// ------------------------
				// PLAYER
				// ------------------------
				playerModel: undefined,
				playerTurret: undefined,
				playerTarget: undefined,
				// ----------------
				pointerLocked: true,
				// ----------------
				moveForward: false,
				moveBackward: false,
				turnLeft: false,
				turnRight: false,
				shoot: false,
				isReversing: false,
				keyMap: {
					KeyW: false,
					KeyS: false,
					KeyA: false,
					KeyD: false,
					Space: false,
					KeyQ: false,
				},
				updatePhysics: function () {
					// // Mettre à jour la position de _scene.player à travers son corps rigide
					// let playerPhysicsBody = this.TARGET.userData.physicsBody;
					// let ms = playerPhysicsBody.getMotionState();
					// if (ms) {
					// 	let transform = new Ammo.btTransform();
					// 	ms.getWorldTransform(transform);
					// 	let position = transform.getOrigin();
					// 	position.setX(position.x() + this.inputVelocity.x);
					// 	position.setY(position.y() + this.inputVelocity.y);
					// 	position.setZ(position.z() + this.inputVelocity.z);


					// 	transform.setOrigin(position);

					// 	let rotation = new Ammo.btQuaternion(this.quaternion.x, this.quaternion.y, this.quaternion.z, this.quaternion.w);
					// 	transform.setRotation(rotation);


					// 	ms.setWorldTransform(transform);
					// 	playerPhysicsBody.setMotionState(ms);
					// }

				},
				checkMoves: function () {
					this.directionMultiplier = this.moveBackward ? -1 : 1;

					if (this.turnLeft) {
						this.playerModel.rotation.y += 0.05 * this.directionMultiplier;
					} else if (this.turnRight) {
						this.playerModel.rotation.y -= 0.05 * this.directionMultiplier;
					}
					if (this.moveBackward) {
						this.playerModel.translateZ(-0.1);
					} else if (this.moveForward) {
						// console.log((Math.sin(this.time) * 0.1))
						this.playerModel.translateZ(0.1);
					} else {
						this.time = 0;
					}
					if (this.shoot) {
						console.log('shoot', this.shoot)
					}
				},
				onDocumentKey: function (e) {
					// console.log('e.code', e.code)
					if (e.type === "keydown" || e.type === "keyup") {
						_Player.keyMap[e.code] = e.type === "keydown";
					}
					if (_Player.pointerLocked) {
						_Player.moveForward = _Player.keyMap["KeyW"];
						_Player.moveBackward = _Player.keyMap["KeyS"];
						_Player.turnLeft = _Player.keyMap["KeyA"];
						_Player.turnRight = _Player.keyMap["KeyD"];
						_Player.shoot = _Player.keyMap["Space"] || _Player.keyMap["KeyQ"];;
					}
				},
				pointerManager: function () {
					document.addEventListener("pointerlockchange", () => {
						if (document.pointerLockElement === _scene.renderer.domElement) {
							_Player.pointerLocked = true;

							_Player.startButton.style.display = "none";
							_Player.menuPanel.style.display = "none";

							document.addEventListener("keydown", _Player.onDocumentKey, false);
							document.addEventListener("keyup", _Player.onDocumentKey, false);

							_scene.renderer.domElement.addEventListener("mousemove", _OrbitControls.onDocumentMouseMove, false);
							_scene.renderer.domElement.addEventListener("wheel", _OrbitControls.onDocumentMouseWheel, false);
						} else {
							_Player.pointerLocked = false;

							_Player.menuPanel.style.display = "block";

							document.removeEventListener("keydown", _Player.onDocumentKey, false);
							document.removeEventListener("keyup", _Player.onDocumentKey, false);

							_scene.renderer.domElement.removeEventListener(
								"mousemove",
								_OrbitControls.onDocumentMouseMove,
								false
							);
							_scene.renderer.domElement.removeEventListener(
								"wheel",
								_OrbitControls.onDocumentMouseWheel,
								false
							);

							setTimeout(() => {
								_Player.startButton.style.display = "block";
							}, 1000);
						}
					});
				},
				panelManager: function () {
					this.menuPanel = document.createElement('div')
					this.startButton = document.createElement('div')
					this.menuPanel.id = 'menuPanel'
					this.startButton.id = 'startButton'
					this.startButton.textContent = 'startButton'
					this.menuPanel.appendChild(this.startButton)
					document.body.appendChild(this.menuPanel)
					this.startButton.addEventListener(
						"click",
						() => {
							_scene.renderer.domElement.requestPointerLock();
						},
						false
					);
				},
				init: function () {
					// _GLTFLoader.addModelsToScene(scene)

					this.playerModel = clone(_GLTFLoader.models.tank1)
					this.playerSkin = this.playerModel.children[0].children[0]
					this.playerTurret = this.playerModel.children[0].children[3]

					this.playerModel.position.set(0, .5, 0)

					// this.playerModel.rotation.set(0, 0, 0)
					// this.playerModel.name = 'playerOne'

					this.playerSkin.material.color.r = 1
					this.playerSkin.material.color.g = 1
					this.playerSkin.material.color.b = 1
					this.playerTurret.material.color.r = 1
					this.playerTurret.material.color.g = 1
					this.playerTurret.material.color.b = 0

					_scene.scene.add(this.playerModel)

					this.panelManager()
					this.pointerManager()
					// orbitControls.set_cameraPivot()

				}

			};
			let addstuftoWorld = () => {
				let physicObjects = {
					objs: [
						{ scales: new THREE.Vector3(1000, .5, 1000), pos: new THREE.Vector3(0, -.25, 0), mass: 0, color: 0xffffff, rotation_q: null, categorie: 'Box', name: 'Floor_Lv0' },
						{ scales: new THREE.Vector3(1, 1, 1), pos: new THREE.Vector3(-5, 2, 5), mass: 0.00000001, color: 0x00ffff, rotation_q: null, categorie: 'Box', name: 'plot_NW' },
						{ scales: new THREE.Vector3(1, 1, 1), pos: new THREE.Vector3(-5, 2, -5), mass: 0.00000001, color: 0xffff00, rotation_q: null, categorie: 'Box', name: 'plot_SW' },
						{ scales: new THREE.Vector3(1, 1, 1), pos: new THREE.Vector3(5, 0.5, -5), mass: 0.00000001, color: 0xffff00, rotation_q: null, categorie: 'Box', name: 'plot_SE' },
						{ scales: new THREE.Vector3(1, 1, 1), pos: new THREE.Vector3(5, 0.5, 5), mass: 0.00000001, color: 0xffff00, rotation_q: null, categorie: 'Box', name: 'plot_NE' },
						{ scales: new THREE.Vector3(40, 1, .5), pos: new THREE.Vector3(0, 3, -19.75), mass: 0.0001, color: 0x101010, rotation_q: null, categorie: 'Box', name: 'wall_south' },
						{ scales: new THREE.Vector3(40, 1, .5), pos: new THREE.Vector3(0, 3, 19.75), mass: 0.0001, color: 0x101010, rotation_q: null, categorie: 'Box', name: 'wall_north' },
						{ scales: new THREE.Vector3(.5, 1, 39), pos: new THREE.Vector3(19.75, 3, 0), mass: 0.0001, color: 0x101010, rotation_q: null, categorie: 'Box', name: 'wall_est' },
						{ scales: new THREE.Vector3(.5, 1, 39), pos: new THREE.Vector3(-19.75, 3, 0), mass: 0.0001, color: 0x101010, rotation_q: null, categorie: 'Box', name: 'wall_west' },
					],
					init: function () {
						for (let index = 0; index < this.objs.length; index++) {
							const element = this.objs[index];
							let newcube = _physics.createMesh(element.scales, element.pos, element.mass, element.color, element.rotation_q, element.categorie, element.name)
							_scene.scene.add(newcube)
						}
					},
				}
				physicObjects.init()
			}
			let initWorld = (Ammo) => {
				let root = '/tanks';
				let delta = 0;
				_scene.init()
				let clock = new THREE.Clock()
				let scene = _scene.scene
				let camera = _scene.camera
				let renderer = _scene.renderer

				// ------------------------
				// ANIMATION
				// ------------------------
				const animate = function () {
					delta = clock.getDelta()
					requestAnimationFrame(animate);
					_scene.SUN.move()
					// if (_GLTFLoader.demoActive === true) _GLTFLoader.rotTankBase()

					_Player.checkMoves()
					_physics.updatePhysicsWorld(20);

					if (typeof _OrbitControls === 'object') _OrbitControls.update();

					renderer.render(scene, camera);
				};

				// ------------------------
				// STEPS
				// ------------------------
				let STEP5 = () => {
					animate();
				}
				let STEP4 = () => {
					// ------------------------
					// PHYSICS
					// ------------------------
					_physics._initPhysicsWorld()
					addstuftoWorld()

					_Player.init()
					renderer.render(_scene.scene, camera);
					_OrbitControls.init(camera, renderer, _Player)

					STEP5()

				}
				let STEP3 = () => {
					STEP4()
				}
				let STEP2 = () => {
					_TextureLoader.init(root, STEP3)
				}
				let STEP = () => {
					_GLTFLoader.init(root, STEP2)
				}
				// ------------------------
				// Handle window resizing
				// ------------------------
				window.addEventListener('resize', () => {
					renderer.setSize(window.innerWidth, window.innerHeight);
					camera.aspect = window.innerWidth / window.innerHeight;
					camera.updateProjectionMatrix();
				});

				STEP()
			}
			Ammo().then(initWorld);
			userWindowsConsole()
		</script>
	</body>

</html>
