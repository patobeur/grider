<!DOCTYPE html>
<html lang="fr">

	<head>
		<title>three.js physics</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<link rel="stylesheet" href="/assets/css/main.css">
	</head>

	<body>
		<div id="instructions">
			Q D to rotate tank<br />
			Z S to move forward and backward<br />
			Mousemove to rotate turret<br />
			Mousewheel to dolly in/out<br />
			Spacebar : change ammo model.<br />
			Left mouse clic to fire an ammo !<br />
			console : setcolor(0,0,0) for color1 (0 to 1)<br />
			console : setcolor2(0,0,0) for color2 (0 to 1)
		</div>
		<script src="/node_modules/three/examples/jsm/libs/ammo.wasm.js"></script>
		<script type="importmap">
		{
          "imports": {
            "three": "/node_modules/three/build/three.module.js",
            "three/addons/": "/node_modules/three/examples/jsm/"
          }
        }
      	</script>
		<script type="module">
			"use strict";
			import * as THREE from "three";
			import { _GLTFLoader, _TextureLoader, _scene, _consoleOn, _formulas } from '/js/loaders.js'
			import { _OrbitControls } from '/js/OrbitControls.js';
			import { _physics } from '/js/physics.js';
			import { _sphereBleue } from '/js/sphereBleue.js';
			import { _shoot } from '/js/shoot.js';
			import { _player } from '/js/player.js';
			import { _userConsole } from '/js/userConsole.js';
			import { clone } from 'three/addons/utils/SkeletonUtils.js';
			// let userConsole = function () {
			// 	// Exemple de fonction pour manipuler le tank via la console
			// 	window.setcolor = function (r = 0, g = 0, b = 0) {
			// 		let Skin = _player.playerTankMesh.children[0].children[0]
			// 		Skin.material.color.r = r
			// 		Skin.material.color.g = g
			// 		Skin.material.color.b = b
			// 	};
			// 	window.setcolor2 = function (r = 0, g = 0, b = 0) {
			// 		let Skin = _player.playerTankMesh.children[0].children[3]
			// 		Skin.material.color.r = r
			// 		Skin.material.color.g = g
			// 		Skin.material.color.b = b
			// 	};
			// 	window.moveTankForward = function () {
			// 		_player.moveForward = true;
			// 		_player.moveBackward = false;
			// 	};

			// 	window.moveTankBackward = function () {
			// 		_player.moveForward = false;
			// 		_player.moveBackward = true;
			// 	};

			// 	window.stopTank = function () {
			// 		_player.moveForward = false;
			// 		_player.moveBackward = false;
			// 	};
			// }

			let initWorld = (Ammo) => {
				let root = '';
				let delta = 0;
				_scene.init()
				let clock = new THREE.Clock()
				let scene = _scene.scene
				let camera = _scene.camera
				let renderer = _scene.renderer

				// ------------------------
				// ANIMATION
				// ------------------------
				const animate = function () {
					delta = clock.getDelta()
					requestAnimationFrame(animate);

					_scene.SUN.move()

					if (_GLTFLoader.demoActive === true) _GLTFLoader.rotTankBase()

					_player.checkMoves(delta)// verifier si le tank bouge

					_shoot.update(); // verifier si des projectiles doivent disparaitre...

					_physics.updateWorldPhysics(delta);

					if (typeof _OrbitControls === 'object') _OrbitControls.update();

					renderer.render(scene, camera);
				};


				let starter = () => {
					_physics._initPhysicsWorld()
					_physics.addThemAll(_scene)
					_player.init(_physics)
					_shoot.init(_player.playerTankMesh, _scene, _physics)


					_sphereBleue.init(_player, _physics, _scene);
					_sphereBleue.addRandomSphere(_scene)

					renderer.render(_scene.scene, camera);
					_OrbitControls.init(camera, renderer, _player)

					animate();
				}
				const loadAssets = () => {
					_GLTFLoader.init(root, () => {
						_TextureLoader.init(root, starter)
					})
				}
				// ------------------------
				// Handle window resizing
				// ------------------------
				window.addEventListener('resize', () => {
					renderer.setSize(window.innerWidth, window.innerHeight);
					camera.aspect = window.innerWidth / window.innerHeight;
					camera.updateProjectionMatrix();
				});
				loadAssets()
			}
			Ammo().then(initWorld);
			_userConsole()
		</script>
	</body>

</html>
